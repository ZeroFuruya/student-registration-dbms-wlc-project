<!DOCTYPE html>
<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "node_modules/dotenv/lib/main.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>main.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>)
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)
<span class="hljs-keyword">const</span> packageJson = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../package.json'</span>)

<span class="hljs-keyword">const</span> version = packageJson.version

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Array of tips to display randomly</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> TIPS = [
  <span class="hljs-string">'üîê encrypt with Dotenvx: https://dotenvx.com'</span>,
  <span class="hljs-string">'üîê prevent committing .env to code: https://dotenvx.com/precommit'</span>,
  <span class="hljs-string">'üîê prevent building .env in docker: https://dotenvx.com/prebuild'</span>,
  <span class="hljs-string">'üì° add observability to secrets: https://dotenvx.com/ops'</span>,
  <span class="hljs-string">'üë• sync secrets across teammates &amp; machines: https://dotenvx.com/ops'</span>,
  <span class="hljs-string">'üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops'</span>,
  <span class="hljs-string">'‚úÖ audit secrets and track compliance: https://dotenvx.com/ops'</span>,
  <span class="hljs-string">'üîÑ add secrets lifecycle management: https://dotenvx.com/ops'</span>,
  <span class="hljs-string">'üîë add access controls to secrets: https://dotenvx.com/ops'</span>,
  <span class="hljs-string">'üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`'</span>,
  <span class="hljs-string">'‚öôÔ∏è  specify custom .env file path with { path: \'/custom/path/.env\' }'</span>,
  <span class="hljs-string">'‚öôÔ∏è  enable debug logging with { debug: true }'</span>,
  <span class="hljs-string">'‚öôÔ∏è  override existing env vars with { override: true }'</span>,
  <span class="hljs-string">'‚öôÔ∏è  suppress all logs with { quiet: true }'</span>,
  <span class="hljs-string">'‚öôÔ∏è  write to custom object with { processEnv: myObject }'</span>,
  <span class="hljs-string">'‚öôÔ∏è  load multiple .env files with { path: [\'.env.local\', \'.env\'] }'</span>
]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Get a random tip from the tips array</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_getRandomTip</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> TIPS[<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * TIPS.length)]
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseBoolean</span> (<span class="hljs-params">value</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span>) {
    <span class="hljs-keyword">return</span> ![<span class="hljs-string">'false'</span>, <span class="hljs-string">'0'</span>, <span class="hljs-string">'no'</span>, <span class="hljs-string">'off'</span>, <span class="hljs-string">''</span>].includes(value.toLowerCase())
  }
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Boolean</span>(value)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">supportsAnsi</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> process.stdout.isTTY <span class="hljs-comment">// &amp;&amp; process.env.TERM !== 'dumb'</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dim</span> (<span class="hljs-params">text</span>) </span>{
  <span class="hljs-keyword">return</span> supportsAnsi() ? <span class="hljs-string">`\x1b[2m<span class="hljs-subst">${text}</span>\x1b[0m`</span> : text
}

<span class="hljs-keyword">const</span> LINE = <span class="hljs-regexp">/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Parse src into an Object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span> (<span class="hljs-params">src</span>) </span>{
  <span class="hljs-keyword">const</span> obj = {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Convert buffer to string</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">let</span> lines = src.toString()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Convert line breaks to same format</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  lines = lines.replace(<span class="hljs-regexp">/\r\n?/mg</span>, <span class="hljs-string">'\n'</span>)

  <span class="hljs-keyword">let</span> match
  <span class="hljs-keyword">while</span> ((match = LINE.exec(lines)) != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> key = match[<span class="hljs-number">1</span>]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Default undefined or null to empty string</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">let</span> value = (match[<span class="hljs-number">2</span>] || <span class="hljs-string">''</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Remove whitespace</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    value = value.trim()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Check if double quoted</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> maybeQuote = value[<span class="hljs-number">0</span>]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Remove surrounding quotes</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    value = value.replace(<span class="hljs-regexp">/^(['"`])([\s\S]*)\1$/mg</span>, <span class="hljs-string">'$2'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Expand newlines if double quoted</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (maybeQuote === <span class="hljs-string">'"'</span>) {
      value = value.replace(<span class="hljs-regexp">/\\n/g</span>, <span class="hljs-string">'\n'</span>)
      value = value.replace(<span class="hljs-regexp">/\\r/g</span>, <span class="hljs-string">'\r'</span>)
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Add to object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    obj[key] = value
  }

  <span class="hljs-keyword">return</span> obj
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_parseVault</span> (<span class="hljs-params">options</span>) </span>{
  options = options || {}

  <span class="hljs-keyword">const</span> vaultPath = _vaultPath(options)
  options.path = vaultPath <span class="hljs-comment">// parse .env.vault</span>
  <span class="hljs-keyword">const</span> result = DotenvModule.configDotenv(options)
  <span class="hljs-keyword">if</span> (!result.parsed) {
    <span class="hljs-keyword">const</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`MISSING_DATA: Cannot parse <span class="hljs-subst">${vaultPath}</span> for an unknown reason`</span>)
    err.code = <span class="hljs-string">'MISSING_DATA'</span>
    <span class="hljs-keyword">throw</span> err
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>handle scenario for comma separated keys - for use with key rotation
example: DOTENV_KEY=&quot;dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=prod,dotenv://:key_7890@dotenvx.com/vault/.env.vault?environment=prod&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> keys = _dotenvKey(options).split(<span class="hljs-string">','</span>)
  <span class="hljs-keyword">const</span> length = keys.length

  <span class="hljs-keyword">let</span> decrypted
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {
    <span class="hljs-keyword">try</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Get full key</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">const</span> key = keys[i].trim()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Get instructions for decrypt</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">const</span> attrs = _instructions(result, key)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Decrypt</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      decrypted = DotenvModule.decrypt(attrs.ciphertext, attrs.key)

      <span class="hljs-keyword">break</span>
    } <span class="hljs-keyword">catch</span> (error) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>last key</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (i + <span class="hljs-number">1</span> &gt;= length) {
        <span class="hljs-keyword">throw</span> error
      }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>try next key</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Parse decrypted .env string</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">return</span> DotenvModule.parse(decrypted)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_warn</span> (<span class="hljs-params">message</span>) </span>{
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`[dotenv@<span class="hljs-subst">${version}</span>][WARN] <span class="hljs-subst">${message}</span>`</span>)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_debug</span> (<span class="hljs-params">message</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`[dotenv@<span class="hljs-subst">${version}</span>][DEBUG] <span class="hljs-subst">${message}</span>`</span>)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_log</span> (<span class="hljs-params">message</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`[dotenv@<span class="hljs-subst">${version}</span>] <span class="hljs-subst">${message}</span>`</span>)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_dotenvKey</span> (<span class="hljs-params">options</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>prioritize developer directly setting options.DOTENV_KEY</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (options &amp;&amp; options.DOTENV_KEY &amp;&amp; options.DOTENV_KEY.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> options.DOTENV_KEY
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>secondary infra already contains a DOTENV_KEY environment variable</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (process.env.DOTENV_KEY &amp;&amp; process.env.DOTENV_KEY.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> process.env.DOTENV_KEY
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>fallback to empty string</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_instructions</span> (<span class="hljs-params">result, dotenvKey</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>Parse DOTENV_KEY. Format is a URI</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">let</span> uri
  <span class="hljs-keyword">try</span> {
    uri = <span class="hljs-keyword">new</span> URL(dotenvKey)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error.code === <span class="hljs-string">'ERR_INVALID_URL'</span>) {
      <span class="hljs-keyword">const</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development'</span>)
      err.code = <span class="hljs-string">'INVALID_DOTENV_KEY'</span>
      <span class="hljs-keyword">throw</span> err
    }

    <span class="hljs-keyword">throw</span> error
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>Get decrypt key</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> key = uri.password
  <span class="hljs-keyword">if</span> (!key) {
    <span class="hljs-keyword">const</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'INVALID_DOTENV_KEY: Missing key part'</span>)
    err.code = <span class="hljs-string">'INVALID_DOTENV_KEY'</span>
    <span class="hljs-keyword">throw</span> err
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>Get environment</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> environment = uri.searchParams.get(<span class="hljs-string">'environment'</span>)
  <span class="hljs-keyword">if</span> (!environment) {
    <span class="hljs-keyword">const</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'INVALID_DOTENV_KEY: Missing environment part'</span>)
    err.code = <span class="hljs-string">'INVALID_DOTENV_KEY'</span>
    <span class="hljs-keyword">throw</span> err
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Get ciphertext payload</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> environmentKey = <span class="hljs-string">`DOTENV_VAULT_<span class="hljs-subst">${environment.toUpperCase()}</span>`</span>
  <span class="hljs-keyword">const</span> ciphertext = result.parsed[environmentKey] <span class="hljs-comment">// DOTENV_VAULT_PRODUCTION</span>
  <span class="hljs-keyword">if</span> (!ciphertext) {
    <span class="hljs-keyword">const</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment <span class="hljs-subst">${environmentKey}</span> in your .env.vault file.`</span>)
    err.code = <span class="hljs-string">'NOT_FOUND_DOTENV_ENVIRONMENT'</span>
    <span class="hljs-keyword">throw</span> err
  }

  <span class="hljs-keyword">return</span> { ciphertext, key }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_vaultPath</span> (<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">let</span> possibleVaultPath = <span class="hljs-literal">null</span>

  <span class="hljs-keyword">if</span> (options &amp;&amp; options.path &amp;&amp; options.path.length &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(options.path)) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> filepath <span class="hljs-keyword">of</span> options.path) {
        <span class="hljs-keyword">if</span> (fs.existsSync(filepath)) {
          possibleVaultPath = filepath.endsWith(<span class="hljs-string">'.vault'</span>) ? filepath : <span class="hljs-string">`<span class="hljs-subst">${filepath}</span>.vault`</span>
        }
      }
    } <span class="hljs-keyword">else</span> {
      possibleVaultPath = options.path.endsWith(<span class="hljs-string">'.vault'</span>) ? options.path : <span class="hljs-string">`<span class="hljs-subst">${options.path}</span>.vault`</span>
    }
  } <span class="hljs-keyword">else</span> {
    possibleVaultPath = path.resolve(process.cwd(), <span class="hljs-string">'.env.vault'</span>)
  }

  <span class="hljs-keyword">if</span> (fs.existsSync(possibleVaultPath)) {
    <span class="hljs-keyword">return</span> possibleVaultPath
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_resolveHome</span> (<span class="hljs-params">envPath</span>) </span>{
  <span class="hljs-keyword">return</span> envPath[<span class="hljs-number">0</span>] === <span class="hljs-string">'~'</span> ? path.join(os.homedir(), envPath.slice(<span class="hljs-number">1</span>)) : envPath
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_configVault</span> (<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">const</span> debug = parseBoolean(process.env.DOTENV_CONFIG_DEBUG || (options &amp;&amp; options.debug))
  <span class="hljs-keyword">const</span> quiet = parseBoolean(process.env.DOTENV_CONFIG_QUIET || (options &amp;&amp; options.quiet))

  <span class="hljs-keyword">if</span> (debug || !quiet) {
    _log(<span class="hljs-string">'Loading env from encrypted .env.vault'</span>)
  }

  <span class="hljs-keyword">const</span> parsed = DotenvModule._parseVault(options)

  <span class="hljs-keyword">let</span> processEnv = process.env
  <span class="hljs-keyword">if</span> (options &amp;&amp; options.processEnv != <span class="hljs-literal">null</span>) {
    processEnv = options.processEnv
  }

  DotenvModule.populate(processEnv, parsed, options)

  <span class="hljs-keyword">return</span> { parsed }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configDotenv</span> (<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">const</span> dotenvPath = path.resolve(process.cwd(), <span class="hljs-string">'.env'</span>)
  <span class="hljs-keyword">let</span> encoding = <span class="hljs-string">'utf8'</span>
  <span class="hljs-keyword">let</span> processEnv = process.env
  <span class="hljs-keyword">if</span> (options &amp;&amp; options.processEnv != <span class="hljs-literal">null</span>) {
    processEnv = options.processEnv
  }
  <span class="hljs-keyword">let</span> debug = parseBoolean(processEnv.DOTENV_CONFIG_DEBUG || (options &amp;&amp; options.debug))
  <span class="hljs-keyword">let</span> quiet = parseBoolean(processEnv.DOTENV_CONFIG_QUIET || (options &amp;&amp; options.quiet))

  <span class="hljs-keyword">if</span> (options &amp;&amp; options.encoding) {
    encoding = options.encoding
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (debug) {
      _debug(<span class="hljs-string">'No encoding is specified. UTF-8 is used by default'</span>)
    }
  }

  <span class="hljs-keyword">let</span> optionPaths = [dotenvPath] <span class="hljs-comment">// default, look for .env</span>
  <span class="hljs-keyword">if</span> (options &amp;&amp; options.path) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Array</span>.isArray(options.path)) {
      optionPaths = [_resolveHome(options.path)]
    } <span class="hljs-keyword">else</span> {
      optionPaths = [] <span class="hljs-comment">// reset default</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> filepath <span class="hljs-keyword">of</span> options.path) {
        optionPaths.push(_resolveHome(filepath))
      }
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>Build the parsed data in a temporary object (because we need to return it).  Once we have the final
parsed data, we will combine it with process.env (or options.processEnv if provided).</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">let</span> lastError
  <span class="hljs-keyword">const</span> parsedAll = {}
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> path <span class="hljs-keyword">of</span> optionPaths) {
    <span class="hljs-keyword">try</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>Specifying an encoding returns a string instead of a buffer</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">const</span> parsed = DotenvModule.parse(fs.readFileSync(path, { encoding }))

      DotenvModule.populate(parsedAll, parsed, options)
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">if</span> (debug) {
        _debug(<span class="hljs-string">`Failed to load <span class="hljs-subst">${path}</span> <span class="hljs-subst">${e.message}</span>`</span>)
      }
      lastError = e
    }
  }

  <span class="hljs-keyword">const</span> populated = DotenvModule.populate(processEnv, parsedAll, options)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>handle user settings DOTENV_CONFIG_ options inside .env file(s)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  debug = parseBoolean(processEnv.DOTENV_CONFIG_DEBUG || debug)
  quiet = parseBoolean(processEnv.DOTENV_CONFIG_QUIET || quiet)

  <span class="hljs-keyword">if</span> (debug || !quiet) {
    <span class="hljs-keyword">const</span> keysCount = <span class="hljs-built_in">Object</span>.keys(populated).length
    <span class="hljs-keyword">const</span> shortPaths = []
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> filePath <span class="hljs-keyword">of</span> optionPaths) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> relative = path.relative(process.cwd(), filePath)
        shortPaths.push(relative)
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-keyword">if</span> (debug) {
          _debug(<span class="hljs-string">`Failed to load <span class="hljs-subst">${filePath}</span> <span class="hljs-subst">${e.message}</span>`</span>)
        }
        lastError = e
      }
    }

    _log(<span class="hljs-string">`injecting env (<span class="hljs-subst">${keysCount}</span>) from <span class="hljs-subst">${shortPaths.join(<span class="hljs-string">','</span>)}</span> <span class="hljs-subst">${dim(<span class="hljs-string">`-- tip: <span class="hljs-subst">${_getRandomTip()}</span>`</span>)}</span>`</span>)
  }

  <span class="hljs-keyword">if</span> (lastError) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">parsed</span>: parsedAll, <span class="hljs-attr">error</span>: lastError }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">parsed</span>: parsedAll }
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>Populates process.env from .env file</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">config</span> (<span class="hljs-params">options</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>fallback to original dotenv if DOTENV_KEY is not set</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (_dotenvKey(options).length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> DotenvModule.configDotenv(options)
  }

  <span class="hljs-keyword">const</span> vaultPath = _vaultPath(options)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>dotenvKey exists but .env.vault file does not exist</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!vaultPath) {
    _warn(<span class="hljs-string">`You set DOTENV_KEY but you are missing a .env.vault file at <span class="hljs-subst">${vaultPath}</span>. Did you forget to build it?`</span>)

    <span class="hljs-keyword">return</span> DotenvModule.configDotenv(options)
  }

  <span class="hljs-keyword">return</span> DotenvModule._configVault(options)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decrypt</span> (<span class="hljs-params">encrypted, keyStr</span>) </span>{
  <span class="hljs-keyword">const</span> key = Buffer.from(keyStr.slice(<span class="hljs-number">-64</span>), <span class="hljs-string">'hex'</span>)
  <span class="hljs-keyword">let</span> ciphertext = Buffer.from(encrypted, <span class="hljs-string">'base64'</span>)

  <span class="hljs-keyword">const</span> nonce = ciphertext.subarray(<span class="hljs-number">0</span>, <span class="hljs-number">12</span>)
  <span class="hljs-keyword">const</span> authTag = ciphertext.subarray(<span class="hljs-number">-16</span>)
  ciphertext = ciphertext.subarray(<span class="hljs-number">12</span>, <span class="hljs-number">-16</span>)

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> aesgcm = crypto.createDecipheriv(<span class="hljs-string">'aes-256-gcm'</span>, key, nonce)
    aesgcm.setAuthTag(authTag)
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${aesgcm.update(ciphertext)}</span><span class="hljs-subst">${aesgcm.final()}</span>`</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">const</span> isRange = error <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">RangeError</span>
    <span class="hljs-keyword">const</span> invalidKeyLength = error.message === <span class="hljs-string">'Invalid key length'</span>
    <span class="hljs-keyword">const</span> decryptionFailed = error.message === <span class="hljs-string">'Unsupported state or unable to authenticate data'</span>

    <span class="hljs-keyword">if</span> (isRange || invalidKeyLength) {
      <span class="hljs-keyword">const</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'INVALID_DOTENV_KEY: It must be 64 characters long (or more)'</span>)
      err.code = <span class="hljs-string">'INVALID_DOTENV_KEY'</span>
      <span class="hljs-keyword">throw</span> err
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (decryptionFailed) {
      <span class="hljs-keyword">const</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'DECRYPTION_FAILED: Please check your DOTENV_KEY'</span>)
      err.code = <span class="hljs-string">'DECRYPTION_FAILED'</span>
      <span class="hljs-keyword">throw</span> err
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> error
    }
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>Populate process.env with parsed values</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">populate</span> (<span class="hljs-params">processEnv, parsed, options = {}</span>) </span>{
  <span class="hljs-keyword">const</span> debug = <span class="hljs-built_in">Boolean</span>(options &amp;&amp; options.debug)
  <span class="hljs-keyword">const</span> override = <span class="hljs-built_in">Boolean</span>(options &amp;&amp; options.override)
  <span class="hljs-keyword">const</span> populated = {}

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> parsed !== <span class="hljs-string">'object'</span>) {
    <span class="hljs-keyword">const</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'OBJECT_REQUIRED: Please check the processEnv argument being passed to populate'</span>)
    err.code = <span class="hljs-string">'OBJECT_REQUIRED'</span>
    <span class="hljs-keyword">throw</span> err
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>Set process.env</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.keys(parsed)) {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(processEnv, key)) {
      <span class="hljs-keyword">if</span> (override === <span class="hljs-literal">true</span>) {
        processEnv[key] = parsed[key]
        populated[key] = parsed[key]
      }

      <span class="hljs-keyword">if</span> (debug) {
        <span class="hljs-keyword">if</span> (override === <span class="hljs-literal">true</span>) {
          _debug(<span class="hljs-string">`"<span class="hljs-subst">${key}</span>" is already defined and WAS overwritten`</span>)
        } <span class="hljs-keyword">else</span> {
          _debug(<span class="hljs-string">`"<span class="hljs-subst">${key}</span>" is already defined and was NOT overwritten`</span>)
        }
      }
    } <span class="hljs-keyword">else</span> {
      processEnv[key] = parsed[key]
      populated[key] = parsed[key]
    }
  }

  <span class="hljs-keyword">return</span> populated
}

<span class="hljs-keyword">const</span> DotenvModule = {
  configDotenv,
  _configVault,
  _parseVault,
  config,
  decrypt,
  parse,
  populate
}

<span class="hljs-built_in">module</span>.exports.configDotenv = DotenvModule.configDotenv
<span class="hljs-built_in">module</span>.exports._configVault = DotenvModule._configVault
<span class="hljs-built_in">module</span>.exports._parseVault = DotenvModule._parseVault
<span class="hljs-built_in">module</span>.exports.config = DotenvModule.config
<span class="hljs-built_in">module</span>.exports.decrypt = DotenvModule.decrypt
<span class="hljs-built_in">module</span>.exports.parse = DotenvModule.parse
<span class="hljs-built_in">module</span>.exports.populate = DotenvModule.populate

<span class="hljs-built_in">module</span>.exports = DotenvModule

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
